{"version":3,"sources":["../../src/google-maps-overlay.js"],"names":["HIDE_ALL_LAYERS","GL_STATE","depthMask","depthTest","blend","blendFunc","blendEquation","noop","defaultProps","interleaved","GoogleMapsOverlay","props","_map","setProps","map","_overlay","setMap","UNINITIALIZED","google","maps","RenderingType","renderingType","getRenderingType","_createOverlay","addListener","Object","assign","_deck","style","canvas","parentElement","params","pickObject","pickMultipleObjects","pickObjects","VECTOR","isVectorMap","WebGLOverlayView","OverlayView","overlay","onAdd","onContextRestored","_onContextRestored","bind","onDraw","_onDrawVectorInterleaved","_onAdd","_onDrawVectorOverlay","onContextLost","_onContextLost","draw","_onDrawRaster","onRemove","_onRemove","gl","_customRender","requestRedraw","deck","animationLoop","_renderFrame","ab","getParameter","onRender","bindBuffer","layerFilter","width","height","left","top","rest","parentStyle","altitude","viewState","repeat","redraw","transformer","layerManager","_framebuffer","needsRedraw","clearRedrawFlags","viewport","scissor","stencilFunc","_drawLayers","clearCanvas"],"mappings":"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","sourcesContent":["/* global google */\nimport {getParameters, setParameters, withParameters} from '@luma.gl/core';\nimport GL from '@luma.gl/constants';\nimport {\n  createDeckInstance,\n  destroyDeckInstance,\n  getViewPropsFromOverlay,\n  getViewPropsFromCoordinateTransformer\n} from './utils';\n\nconst HIDE_ALL_LAYERS = () => false;\nconst GL_STATE = {\n  depthMask: true,\n  depthTest: true,\n  blend: true,\n  blendFunc: [GL.SRC_ALPHA, GL.ONE_MINUS_SRC_ALPHA, GL.ONE, GL.ONE_MINUS_SRC_ALPHA],\n  blendEquation: GL.FUNC_ADD\n};\n\nfunction noop() {}\n\nconst defaultProps = {\n  interleaved: true\n};\n\nexport default class GoogleMapsOverlay {\n  constructor(props) {\n    this.props = {};\n    this._map = null;\n    this.setProps({...defaultProps, ...props});\n  }\n\n  /* Public API */\n\n  setMap(map) {\n    if (map === this._map) {\n      return;\n    }\n    if (this._map) {\n      this._overlay.setMap(null);\n      this._map = null;\n    }\n    if (map) {\n      this._map = map;\n      const {UNINITIALIZED} = google.maps.RenderingType;\n      const renderingType = map.getRenderingType();\n      if (renderingType !== UNINITIALIZED) {\n        this._createOverlay(map);\n      } else {\n        map.addListener('renderingtype_changed', () => {\n          this._createOverlay(map);\n        });\n      }\n    }\n  }\n\n  setProps(props) {\n    Object.assign(this.props, props);\n    if (this._deck) {\n      if (props.style) {\n        Object.assign(this._deck.canvas.parentElement.style, props.style);\n        props.style = null;\n      }\n      this._deck.setProps(props);\n    }\n  }\n\n  pickObject(params) {\n    return this._deck && this._deck.pickObject(params);\n  }\n\n  pickMultipleObjects(params) {\n    return this._deck && this._deck.pickMultipleObjects(params);\n  }\n\n  pickObjects(params) {\n    return this._deck && this._deck.pickObjects(params);\n  }\n\n  finalize() {\n    this.setMap(null);\n    if (this._deck) {\n      destroyDeckInstance(this._deck);\n      this._deck = null;\n    }\n  }\n\n  /* Private API */\n  _createOverlay(map) {\n    const {interleaved} = this.props;\n    const {VECTOR, UNINITIALIZED} = google.maps.RenderingType;\n    const renderingType = map.getRenderingType();\n    if (renderingType === UNINITIALIZED) {\n      return;\n    }\n    const isVectorMap = renderingType === VECTOR && google.maps.WebGLOverlayView;\n    const OverlayView = isVectorMap ? google.maps.WebGLOverlayView : google.maps.OverlayView;\n    const overlay = new OverlayView();\n\n    // Lifecycle methods are different depending on map type\n    if (isVectorMap) {\n      if (interleaved) {\n        overlay.onAdd = noop;\n        overlay.onContextRestored = this._onContextRestored.bind(this);\n        overlay.onDraw = this._onDrawVectorInterleaved.bind(this);\n      } else {\n        overlay.onAdd = this._onAdd.bind(this);\n        overlay.onContextRestored = noop;\n        overlay.onDraw = this._onDrawVectorOverlay.bind(this);\n      }\n      overlay.onContextLost = this._onContextLost.bind(this);\n    } else {\n      overlay.onAdd = this._onAdd.bind(this);\n      overlay.draw = this._onDrawRaster.bind(this);\n    }\n    overlay.onRemove = this._onRemove.bind(this);\n\n    this._overlay = overlay;\n    this._overlay.setMap(map);\n  }\n\n  _onAdd() {\n    this._deck = createDeckInstance(this._map, this._overlay, this._deck, this.props);\n  }\n\n  _onContextRestored({gl}) {\n    const _customRender = () => {\n      this._overlay.requestRedraw();\n    };\n    const deck = createDeckInstance(this._map, this._overlay, this._deck, {\n      gl,\n      _customRender,\n      ...this.props\n    });\n    this._deck = deck;\n\n    // By default, animationLoop._renderFrame invokes\n    // animationLoop.onRender. We override this to wrap\n    // in withParameters so we don't modify the GL state\n    deck.animationLoop._renderFrame = () => {\n      const ab = gl.getParameter(gl.ARRAY_BUFFER_BINDING);\n      withParameters(gl, {}, () => {\n        deck.animationLoop.onRender();\n      });\n      gl.bindBuffer(gl.ARRAY_BUFFER, ab);\n    };\n  }\n\n  _onContextLost() {\n    // TODO this isn't working\n    if (this._deck) {\n      destroyDeckInstance(this._deck);\n      this._deck = null;\n    }\n  }\n\n  _onRemove() {\n    // Clear deck canvas\n    this._deck.setProps({layerFilter: HIDE_ALL_LAYERS});\n  }\n\n  _onDrawRaster() {\n    const deck = this._deck;\n    const {width, height, left, top, ...rest} = getViewPropsFromOverlay(this._map, this._overlay);\n\n    const parentStyle = deck.canvas.parentElement.style;\n    parentStyle.left = `${left}px`;\n    parentStyle.top = `${top}px`;\n\n    const altitude = 10000;\n    deck.setProps({\n      width,\n      height,\n      viewState: {altitude, repeat: true, ...rest}\n    });\n    // Deck is initialized\n    deck.redraw();\n  }\n\n  // Vector code path\n  _onDrawVectorInterleaved({gl, transformer}) {\n    if (!this._deck || !this._map) {\n      return;\n    }\n\n    const deck = this._deck;\n\n    deck.setProps({\n      ...getViewPropsFromCoordinateTransformer(this._map, transformer),\n\n      // Using external gl context - do not set css size\n      width: false,\n      height: false\n    });\n\n    if (deck.layerManager) {\n      // As an optimization, some renders are to an separate framebuffer\n      // which we need to pass onto deck\n      const _framebuffer = getParameters(gl, GL.FRAMEBUFFER_BINDING);\n      deck.setProps({_framebuffer});\n\n      // Camera changed, will trigger a map repaint right after this\n      // Clear any change flag triggered by setting viewState so that deck does not request\n      // a second repaint\n      deck.needsRedraw({clearRedrawFlags: true});\n\n      // Workaround for bug in Google maps where viewport state is wrong\n      // TODO remove once fixed\n      setParameters(gl, {\n        viewport: [0, 0, gl.canvas.width, gl.canvas.height],\n        scissor: [0, 0, gl.canvas.width, gl.canvas.height],\n        stencilFunc: [gl.ALWAYS, 0, 255, gl.ALWAYS, 0, 255]\n      });\n\n      withParameters(gl, GL_STATE, () => {\n        deck._drawLayers('google-vector', {\n          clearCanvas: false\n        });\n      });\n    }\n  }\n\n  _onDrawVectorOverlay({gl, transformer}) {\n    if (!this._deck || !this._map) {\n      return;\n    }\n\n    const deck = this._deck;\n    deck.setProps({\n      ...getViewPropsFromCoordinateTransformer(this._map, transformer)\n    });\n    deck.redraw();\n  }\n}\n"],"file":"google-maps-overlay.js"}